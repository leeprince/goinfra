"use strict";function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function e(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o)},n:function n(){var step=it.next();normalCompletion=step.done;return step},e:function e(_e2){didErr=true;err=_e2},f:function f(){try{if(!normalCompletion&&it["return"]!=null)it["return"]()}finally{if(didErr)throw err}}}}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key])}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}function _defineProperty(obj,key,value){key=_toPropertyKey(key);if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _toPropertyKey(arg){var key=_toPrimitive(arg,"string");return _typeof(key)==="symbol"?key:String(key)}function _toPrimitive(input,hint){if(_typeof(input)!=="object"||input===null)return input;var prim=input[Symbol.toPrimitive];if(prim!==undefined){var res=prim.call(input,hint||"default");if(_typeof(res)!=="object")return res;throw new TypeError("@@toPrimitive must return a primitive value.")}return(hint==="string"?String:Number)(input)}(function(){"use strict";var _reciveSocketMsgMap;var getUrlQuery=function getUrlQuery(url,field){var url=url?url:window.location.href,reg,queryString;if(field){reg=new RegExp("[?&]"+field+"=([^&#]*)","i");try{queryString=reg.exec(url)[1]}catch(e){queryString=null}}else{queryString=url.substring(url.indexOf("?")+1)}return queryString};function addEvent(elem,eventName,callbackFunction){if(elem.addEventListener){elem.addEventListener(eventName,callbackFunction,false)}else{elem.attachEvent("on"+eventName,callbackFunction)}}var postMsgFilter=function postMsgFilter(postMsg){var regex=/uc_msg|oppo_night|weibo|msfapi|axure/i,_toString=Object.prototype.toString,postMsgUrl;try{postMsgUrl=_toString.call(postMsg)=="[object String]"&&JSON.parse(postMsg).ldpUrl;if(regex.test(postMsgUrl)){return postMsg}}catch(e){console.error("PostMsg Parse Error "+postMsg)}if(!postMsg||_toString.call(postMsg)!=="[object String]"||regex.test(postMsg)){return false}return postMsg};var postMsg=function(){var msgData,flagKey="QD_PM",flagVal="CHAT";function receive(target,cb){addEvent(target,"message",function(e){var postMsg=postMsgFilter(e.data);if(postMsg){try{msgData=JSON.parse(postMsg)}catch(e){console.error("PostMsg Parse Error "+postMsg)}typeof cb=="function"?cb(msgData):""}else{return}})}function send(postMsgData,sendFlagVal){var sendData=msgData?$.extend(msgData,postMsgData):postMsgData;var _flagVal=sendFlagVal||flagVal;if(!sendData.hasOwnProperty(flagKey)||sendData[flagKey]!=_flagVal){sendData[flagKey]=_flagVal}sendData=typeof sendData!="string"?JSON.stringify(sendData):sendData;window.parent.postMessage(sendData,"*")}return{receive:receive,send:send}}();var doc=document;function setCookie(name,value,domain,path,expires){if(expires){expires=new Date(+new Date+expires)}var tempcookie=name+"="+escape(value)+(expires?"; expires="+expires.toGMTString():"")+(path?"; path="+path:"")+(domain?"; domain="+domain:"");if(tempcookie.length<4096){doc.cookie=tempcookie}return this}function getCookie(name){var carr=doc.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));if(carr!=null){return unescape(carr[2])}return null}var memorydb=function memorydb(){var ms={};function getItem(key){return key in ms?ms[key]:false}function setItem(key,value){ms[key]=value;return true}function removeItem(key){var found=(key in ms);if(found){return delete ms[key]}else{return false}}function clear(){ms={};return true}return{type:"memory",getItem:getItem,setItem:setItem,removeItem:removeItem,clear:clear}};var isInIframe=function(){return window.parent==window?false:true}();var globalVars={win:window,receptionist:{},wpaDetail:{WPA_LOGIN_CONFIG:{}},isInIframe:isInIframe,seqs:{key:"",data:[]},thirdAppConfig:{enable:false,type:"",appType:0,appId:"",openId:"",userInfo:null}};var userAgent=globalVars.win.navigator.userAgent.toLocaleLowerCase();globalVars.userAgent=userAgent;var msgdb=function(global){var ls=memorydb();var QUOTA_EXCEEDED_ERR_CODE=22;try{if("localStorage"in global&&global.localStorage){global.localStorage.setItem("test","test");global.localStorage.removeItem("test");ls=global.localStorage}}catch(e){}function get(key){return ls.getItem(key)}function set(key,value){var flag=false;try{ls.setItem(key,value);flag=true}catch(e){console.log("\u6D88\u606F\u5199\u5165\u7F13\u5B58\u5931\u8D25: ",e,e.code);flag=false;if(QUOTA_EXCEEDED_ERR_CODE===e.code){var _globalVars$seqs=globalVars.seqs,seqKey=_globalVars$seqs.key,seqData=_globalVars$seqs.data;var INDEX_KEY="".concat(seqKey.substring(0,seqKey.length-4),"index");do{var halfCount=Math.round(seqData.length/2);var delSeqs=seqData.splice(0,halfCount);delSeqs.forEach(function(s){return remove("".concat(INDEX_KEY).concat(s))});try{ls.setItem(key,value);flag=true;ls.setItem(seqKey,JSON.stringify(seqData));var _globalVars$reception=globalVars.receptionist,kfUin=_globalVars$reception.kfUin,visitorId=_globalVars$reception.visitorId;var historyKey="kf".concat(kfUin);var historyCounts=JSON.parse(ls.getItem(historyKey))||[];for(var i=0;i<historyCounts.length;i++){var element=historyCounts[i];if(element.visitorId===visitorId){element.total=seqData.length;break}}ls.setItem(historyKey,JSON.stringify(historyCounts))}catch(error){console.log("\u7F13\u5B58\u5C1D\u8BD5\u63D2\u5165\u5931\u8D25\uFF0C\u7EE7\u7EED\u5220\u9664\u91CD\u8BD5\uFF01");flag=false}}while(!flag)}}return flag}function remove(key){return ls.removeItem(key)}function clear(){return ls.clear()}return{type:ls.type,get:get,set:set,remove:remove,clear:clear}}(window);function getVisitorId(fromURL){var key="tencentSig",visitorId,isLocalStorageSupported=typeof msgdb.type==="undefined"||msgdb.type==="memory"?true:false;if(globalVars.thirdAppConfig.secretKey){key="tencentThirdSig"}var _fromURL={active:false,url:""};$.extend(_fromURL,fromURL);function get(){var active=_fromURL.active,url=_fromURL.url;var visitorId=active?getUrlQuery(url,"visitorId"):getCookie(key);if(!/^\d+$/.test(visitorId)){visitorId=""}if(!active&&isLocalStorageSupported){if(!visitorId){visitorId=msgdb.get(key);if(!/^\d+$/.test(visitorId)){visitorId=""}}else{msgdb.set(key,visitorId)}}return visitorId}function set(){var tmpVisitorId=(Math.floor(Math.random()*10)||1)+_uuid(3,10)+new Date().getTime().toString().slice(2,13);if(isLocalStorageSupported){msgdb.set(key,tmpVisitorId)}else{setCookie(key,tmpVisitorId,null,"/",31536000000)}return tmpVisitorId}visitorId=get();if(!visitorId){visitorId=set()}return visitorId}function _uuid(len,radix){var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");var uuid=[],i;radix=radix||chars.length;if(len){for(i=0;i<len;i++)uuid[i]=chars[0|Math.random()*radix]}else{var r;uuid[8]=uuid[13]=uuid[18]=uuid[23]="-";uuid[14]="4";for(i=0;i<36;i++){if(!uuid[i]){r=0|Math.random()*16;uuid[i]=chars[i==19?r&3|8:r]}}}return uuid.join("")}function pageVisibility(){var _isHidden=undefined;var customEvent=null;var _isIE=function _isIE(version){var b=document.createElement("b");b.innerHTML="<!--[if IE "+version+"]><i></i><![endif]-->";return b.getElementsByTagName("i").length===1};var isIE=_isIE();var isIE9=_isIE(9);var prefixSupport=isIE9?"":null,keyWithPrefix=function keyWithPrefix(prefix,key){if(prefix!==""){return prefix+key.slice(0,1).toUpperCase()+key.slice(1)}return key};var isPageVisibilitySupport=function(){var support=false;if(typeof window.screenX==="number"){["webkit","moz","ms","o",""].forEach(function(prefix){if(support==false&&document[keyWithPrefix(prefix,"hidden")]!=undefined){prefixSupport=prefix;support=true}})}return support}();if(isIE&&!isPageVisibilitySupport){if(document.addEventListener){window.addEventListener("focus",onFocus,true);window.addEventListener("blur",onBlur,true)}else{document.attachEvent("onfocusin",onFocus);document.attachEvent("onfocusout",onBlur)}if(typeof document.createEvent!=="undefined"&&!customEvent){customEvent=document.createEvent("HTMLEvents");customEvent.initEvent("visibilitychange",true,true)}else{document.documentElement.visibilitychange=0}}function onFocus(){_isHidden=false;if(isIE9){document.dispatchEvent(customEvent)}else{document.documentElement.visibilitychange=1}}function onBlur(){_isHidden=true;if(isIE9){document.dispatchEvent(customEvent)}else{document.documentElement.visibilitychange=0}}var isHidden=function isHidden(){if(isPageVisibilitySupport){return document[keyWithPrefix(prefixSupport,"hidden")]}else if(typeof _isHidden!=="undefined"){return _isHidden}return undefined};var visibilityState=function visibilityState(){if(isPageVisibilitySupport){return document[keyWithPrefix(prefixSupport,"visibilityState")]}else if(typeof _isHidden!=="undefined"){return _isHidden?"hidden":"visible"}return undefined};return{hidden:isHidden(),isHidden:isHidden,isPageVisibilitySupport:isPageVisibilitySupport,visibilityState:visibilityState(),visibilitychange:function visibilitychange(fn,usecapture){usecapture=false;if(typeof fn==="function"){if(isPageVisibilitySupport||isIE9){return document.addEventListener(prefixSupport+"visibilitychange",function(evt){fn.call(this,evt,isHidden(),visibilityState())},usecapture)}else{document.documentElement.attachEvent("onpropertychange",function(evt){if(event.propertyName=="visibilitychange"){fn.call(this,evt,isHidden(),visibilityState())}})}}return undefined}}}var createRandomId=function createRandomId(){var chars="0123456789",randomId=[],i;randomId[0]=0|Math.random()*10||1;for(i=1;i<4;i++){randomId[i]=chars[0|Math.random()*10]}return randomId.join("")+new Date().getTime().toString().slice(2,13)};var createUuid32=function createUuid32(){return"xxxxxxxxxxxxxxxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})};var isOa=/^oa.*/.test(location.host);var COMP_CONF={appid:6,ws:isOa?"https://testwss.qidian.qq.com":"https://wpa.mango.qidian.qq.com",heartbeat:3*60,CGI_URL:function(){var domain=" https://".concat(isOa?"test":"","gateway.qidian.qq.com");return{SOCKET_CHAT:!!window.WebSocket&&window.WebSocket.prototype.send?"https://".concat(__domain.chat):"https://pollingchat.qidian.qq.com",COMP_SOURCE_URL:"https://".concat(__domain.source,".com/qidian/chatClient/release/comp/"),GET_MSG_DISPLAYED:"".concat(domain,"/v1/wpaVisitor/getMsgDisplayed"),autotInviteConf:"".concat(domain,"/v1/wpaVisitor/getInviteConf"),refuseInvite:"".concat(domain,"/v1/wpaVisitor/refuseInvite"),socketLoginConfig:"".concat(domain,"/v1/interface/inner/cloudim_324034"),POST_MSG_DISPLAYED:"".concat(domain,"/v1/wpaVisitor/displayMessageOnC"),bindWpaAndImAid:"".concat(domain,"/v1/wpaVisitor/aidBind")}}(),isLinkWPA:function(){var pageURL=window.location.href,isLinkWPA=getUrlQuery(pageURL,"linkType"),visitorId=getUrlQuery(pageURL,"visitorId"),isInIframe=window.parent==window?false:true;visitorId&&visitorId.length>0?isLinkWPA=1:"";if(isLinkWPA&&(""+isLinkWPA).length>0&&!isInIframe){return true}return false}(),SOCKET_OPTS:{OPTS:{path:"/session",reconnectionDelay:10000,reconnectionDelayMax:20000,reconnectionAttempts:2,timeout:20000,transports:["websocket"]},C2B_TIMEOUT:60000,SIGT_TIMEOUT:10000,REG_TIMEOUT:60000,SEQ_RANGE:{C2B_FOR_PHP:2147483647,C2B_FOR_PC:65535},CLIENT_PING_DELAY:20000,MAX_FAIL_TIMES:2},SOCKET_CMD:{REG:{EMIT:"register",RECEIVE:"register ack"},C2B:{EMIT:"message c2b",RECEIVE:"message c2b ack"},B2C:{RECEIVE:"message b2c",EMIT:"message b2c ack"},KF_CHANGE:{EMIT:"change kf",RECEIVE:"change kf ack"},ROUTE:{RECEIVE:"route change",EMIT:"route change ack"},OVER:{RECEIVE:"session over"},SESSION_MSG:{RECEIVE:"s_msg",EMIT:"s_msg_ack"},CLIENT_PING:{EMIT:"p"},INITVIDEO:{EMIT:"rtc_create_room",RECEIVE:"rtc_create_room_ack"},ROOMINFO:{EMIT:"rtc_get_room",RECEIVE:"rtc_get_room_ack"},VIDEOEVENT:{EMIT:"rtc_event_report",RECEIVE:"rtc_event_report_ack"},VIDEOSTATUS:{EMIT:"rtc_status_report",RECEIVE:"rtc_status_report_ack"},VIDEOPING:{EMIT:"rtc_health_check",RECEIVE:"rtc_health_check_ack"},VIDEOSMSG:{RECEIVE:"rtc_s_msg",EMIT:"rtc_s_msg_ack"},SESSION_END:{EMIT:"session_end",RECEIVE:"session_end_ack"},SCREEN_SHARE:{EMIT:"rtc_screen_share",RECEIVE:"rtc_screen_share_ack"}}};function postMsgSender(msgData){msgData&&postMsg.send(msgData,"ONLINE_STATUS")}var _hasatob=typeof atob==="function";var _hasbtoa=typeof btoa==="function";var _hasBuffer=typeof Buffer==="function";var _TD=typeof TextDecoder==="function"?new TextDecoder:undefined;var _TE=typeof TextEncoder==="function"?new TextEncoder:undefined;var b64ch="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var b64chs=Array.prototype.slice.call(b64ch);var b64tab=function(a){var tab={};a.forEach(function(c,i){return tab[c]=i});return tab}(b64chs);var b64re=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/;var _fromCC=String.fromCharCode.bind(String);var _U8Afrom=typeof Uint8Array.from==="function"?Uint8Array.from.bind(Uint8Array):function(it){return new Uint8Array(Array.prototype.slice.call(it,0))};var _mkUriSafe=function _mkUriSafe(src){return src.replace(/=/g,"").replace(/[+\/]/g,function(m0){return m0=="+"?"-":"_"})};var _tidyB64=function _tidyB64(s){return s.replace(/[^A-Za-z0-9\+\/]/g,"")};var btoaPolyfill=function btoaPolyfill(bin){var u32,c0,c1,c2,asc="";var pad=bin.length%3;for(var i=0;i<bin.length;){if((c0=bin.charCodeAt(i++))>255||(c1=bin.charCodeAt(i++))>255||(c2=bin.charCodeAt(i++))>255)throw new TypeError("invalid character found");u32=c0<<16|c1<<8|c2;asc+=b64chs[u32>>18&63]+b64chs[u32>>12&63]+b64chs[u32>>6&63]+b64chs[u32&63]}return pad?asc.slice(0,pad-3)+"===".substring(pad):asc};var _btoa=_hasbtoa?function(bin){return btoa(bin)}:_hasBuffer?function(bin){return Buffer.from(bin,"binary").toString("base64")}:btoaPolyfill;var _fromUint8Array=_hasBuffer?function(u8a){return Buffer.from(u8a).toString("base64")}:function(u8a){var maxargs=4096;var strs=[];for(var i=0,l=u8a.length;i<l;i+=maxargs){strs.push(_fromCC.apply(null,u8a.subarray(i,i+maxargs)))}return _btoa(strs.join(""))};var cb_utob=function cb_utob(c){if(c.length<2){var cc=c.charCodeAt(0);return cc<128?c:cc<2048?_fromCC(192|cc>>>6)+_fromCC(128|cc&63):_fromCC(224|cc>>>12&15)+_fromCC(128|cc>>>6&63)+_fromCC(128|cc&63)}else{var cc=65536+(c.charCodeAt(0)-55296)*1024+(c.charCodeAt(1)-56320);return _fromCC(240|cc>>>18&7)+_fromCC(128|cc>>>12&63)+_fromCC(128|cc>>>6&63)+_fromCC(128|cc&63)}};var re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g;var utob=function utob(u){return u.replace(re_utob,cb_utob)};var _encode=_hasBuffer?function(s){return Buffer.from(s,"utf8").toString("base64")}:_TE?function(s){return _fromUint8Array(_TE.encode(s))}:function(s){return _btoa(utob(s))};var encode=function encode(src){var urlsafe=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;return urlsafe?_mkUriSafe(_encode(src)):_encode(src)};var re_btou=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g;var cb_btou=function cb_btou(cccc){switch(cccc.length){case 4:var cp=(7&cccc.charCodeAt(0))<<18|(63&cccc.charCodeAt(1))<<12|(63&cccc.charCodeAt(2))<<6|63&cccc.charCodeAt(3),offset=cp-65536;return _fromCC((offset>>>10)+55296)+_fromCC((offset&1023)+56320);case 3:return _fromCC((15&cccc.charCodeAt(0))<<12|(63&cccc.charCodeAt(1))<<6|63&cccc.charCodeAt(2));default:return _fromCC((31&cccc.charCodeAt(0))<<6|63&cccc.charCodeAt(1));}};var btou=function btou(b){return b.replace(re_btou,cb_btou)};var atobPolyfill=function atobPolyfill(asc){asc=asc.replace(/\s+/g,"");if(!b64re.test(asc))throw new TypeError("malformed base64.");asc+="==".slice(2-(asc.length&3));var u24,bin="",r1,r2;for(var i=0;i<asc.length;){u24=b64tab[asc.charAt(i++)]<<18|b64tab[asc.charAt(i++)]<<12|(r1=b64tab[asc.charAt(i++)])<<6|(r2=b64tab[asc.charAt(i++)]);bin+=r1===64?_fromCC(u24>>16&255):r2===64?_fromCC(u24>>16&255,u24>>8&255):_fromCC(u24>>16&255,u24>>8&255,u24&255)}return bin};var _atob=_hasatob?function(asc){return atob(_tidyB64(asc))}:_hasBuffer?function(asc){return Buffer.from(asc,"base64").toString("binary")}:atobPolyfill;var _toUint8Array=_hasBuffer?function(a){return _U8Afrom(Buffer.from(a,"base64"))}:function(a){return _U8Afrom(_atob(a).split("").map(function(c){return c.charCodeAt(0)}))};var _decode=_hasBuffer?function(a){return Buffer.from(a,"base64").toString("utf8")}:_TD?function(a){return _TD.decode(_toUint8Array(a))}:function(a){return btou(_atob(a))};var _unURI=function _unURI(a){return _tidyB64(a.replace(/[-_]/g,function(m0){return m0=="-"?"+":"/"}))};var decode=function decode(src){return _decode(_unURI(src))};if(!isOa){try{console.log=function(){};console.info=function(){}}catch(ex){}}var socketio=null;var recepitionDetailForUnread={};var SOCKET_NOTIFY={UNREAD_MSG:140,DISPLAY_MSG:141,INVITE:142};var reciveSocketMsgMap=(_reciveSocketMsgMap={},_defineProperty(_reciveSocketMsgMap,SOCKET_NOTIFY.UNREAD_MSG,{DATA_KEY:"msg_visitor_unread_msg_notify",handler:offlineMsgNumListener}),_defineProperty(_reciveSocketMsgMap,SOCKET_NOTIFY.DISPLAY_MSG,{DATA_KEY:"msg_visitor_display_msg_notify",handler:displayListener}),_defineProperty(_reciveSocketMsgMap,SOCKET_NOTIFY.INVITE,{DATA_KEY:"msg_visitor_invite_notify",handler:invitationListener}),_reciveSocketMsgMap);function offlineMsgNumListener(data){var sendData=data,recepitionDetailKey="kfuin"+sendData.kfuin;sendData["number"]=sendData.msgNum||0;delete sendData.seq;delete sendData.msgNum;console.log("msg_visitor_unread_msg_notify",sendData);if(typeof sendData.receptionName!=="undefined"){recepitionDetailForUnread[recepitionDetailKey]=sendData.receptionName}else{sendData.receptionName=recepitionDetailForUnread.hasOwnProperty(recepitionDetailKey)?recepitionDetailForUnread[recepitionDetailKey]:null}postMsgSender({act:"SM_UNREAD",kfuin:sendData.kfuin,data:sendData})}function displayListener(data){var sendData=data,recepitionDetailKey="kfuin"+sendData.kfuin;delete sendData.seq;if(typeof sendData.receptionName!=="undefined"){recepitionDetailForUnread[recepitionDetailKey]=sendData.receptionName}else{sendData.receptionName=recepitionDetailForUnread.hasOwnProperty(recepitionDetailKey)?recepitionDetailForUnread[recepitionDetailKey]:null}sendData.kfuin=globalVars.wpaDetail.kfuin;var WPA_LOGIN_CONFIG=globalVars.wpaDetail.WPA_LOGIN_CONFIG;var postData={act:"SM_DISPLAY",data:_objectSpread(_objectSpread({},sendData),{},{aid:WPA_LOGIN_CONFIG.aid,d2:WPA_LOGIN_CONFIG.d2,appid:COMP_CONF.appid}),kfuin:sendData.kfuin};postMsgSender(postData)}function invitationListener(data){var kfuin=data.kfuin;delete data.kfuin;postMsgSender({act:"SM_MANUAL_INVITE",kfuin:kfuin,data:data})}function initInstant(params){var kfuin=params.kfuin;var WPA_LOGIN_CONFIG=globalVars.wpaDetail.WPA_LOGIN_CONFIG;socketio=Instant.create({kfuin:kfuin,aid:WPA_LOGIN_CONFIG.aid,d2:WPA_LOGIN_CONFIG.d2,url:COMP_CONF.ws,appid:COMP_CONF.appid,token_type:0,skey:"",client_type:5,userdefine:JSON.stringify(params),heartbeat:COMP_CONF.heartbeat});socketio.ready().then(function(info){console.log("Instant Ready",info)});socketio.on(Instant.NOTIFY_MESSAGE_TYPE.NOTIFY_NEW_SC_MESSAGE,function(result){var sc_message_array=result;var _iterator=_createForOfIteratorHelper(sc_message_array),_step;try{var _loop=function _loop(){var sc=_step.value;var subMsgType=sc["uint32_sub_msgtype"];var subCommand=sc["uint32_sub_command"];var scData=JSON.parse(sc["bytes_sc_data"]);console.log("receiveTRC",subMsgType,subCommand,scData);if(subMsgType===528&&subCommand===146){var uint32_sub_cmd=scData["uint32_sub_cmd"];var map=reciveSocketMsgMap[uint32_sub_cmd];var data=scData[map.DATA_KEY];if(map){var newData={};Object.keys(data).forEach(function(k){var val=data[k],newk=k.replace(/^((str)|(uint)).*?_/ig,"");newData[newk]=val});map&&map.handler(newData)}}};for(_iterator.s();!(_step=_iterator.n()).done;){_loop()}}catch(err){_iterator.e(err)}finally{_iterator.f()}})}var maxReTryTime=3;function formatTypeObj(data){var ret={};Object.keys(data).forEach(function(k){var val=data[k],newk=k.replace(/^((str)|(uint)).*?_/ig,"");ret[newk]=val});return ret}function autotInviteConf(data){var kfuin=data.kfuin,isMobile=data.isMobile;var visitorId=data.WPA_LOGIN_CONFIG.aid;$.ajax({url:"".concat(COMP_CONF.CGI_URL.autotInviteConf),data:JSON.stringify({kfuin:kfuin,isMobile:isMobile,visitorId:visitorId}),type:"POST",timeout:5000,dataType:"json",contentType:"application/json;charset=UTF-8",success:function success(res){if(res.code===0){var _data=res.data;postMsgSender({act:"SM_INVITE_CONF",kfuin:res.data.kfuin,inviteRule:_data});_data.unReadMsg&&offlineMsgNumListener(formatTypeObj(_data.unReadMsg));_data.displayMsg&&displayListener(formatTypeObj(_data.displayMsg))}},error:function error(err){console.log("err invite",err)}})}function refuseInvite(data){var kfuin=data.kfuin;var aid=globalVars.wpaDetail.WPA_LOGIN_CONFIG.aid;$.ajax({url:"".concat(COMP_CONF.CGI_URL.refuseInvite),data:JSON.stringify({kfuin:kfuin,visitorId:aid}),type:"POST",timeout:5000,dataType:"json",contentType:"application/json;charset=UTF-8",success:function success(res){if(res.code===0);},error:function error(err){console.log("err \u62D2\u7EDD\u9080\u8BF7\u63A5\u53E3\u62A5\u9519",err)}})}function bindWpaAndImAid(data){var kfuin=data.kfuin,webimAid=data.webimAid,wpaId=data.wpaId;var aid=globalVars.wpaDetail.WPA_LOGIN_CONFIG.aid;$.ajax({url:"".concat(COMP_CONF.CGI_URL.bindWpaAndImAid),data:JSON.stringify({kfuin:kfuin,webimAid:webimAid,wpaAid:aid,wpaId:wpaId}),type:"POST",timeout:5000,dataType:"json",contentType:"application/json;charset=UTF-8",success:function success(res){if(res.code===0);},error:function error(err){console.log("err \u7ED1\u5B9Aaid\u63A5\u53E3\u62A5\u9519",err)}})}function socketLoginConfig(obj){var wpa=JSON.parse(JSON.stringify(obj));var kfuin=wpa.kfuin,WPA_LOGIN_CONFIG=wpa.WPA_LOGIN_CONFIG;var aid=WPA_LOGIN_CONFIG.aid;var d2=WPA_LOGIN_CONFIG.d2||"";if(!!wpa.WPA_LOGIN_CONFIG.auth){initInstant(wpa);return}var postData={uint64_kfuin:kfuin,uint32_appid:COMP_CONF.appid,str_useragent:navigator.userAgent||"",bytes_custom_key:encode(String(aid)),str_session_ticket:d2,str_client_uuid:""};if(!d2){postData.str_client_uuid=WPA_LOGIN_CONFIG.uuid}$.ajax({url:"".concat(COMP_CONF.CGI_URL.socketLoginConfig),data:JSON.stringify(postData),type:"POST",timeout:5000,dataType:"json",contentType:"application/json;charset=UTF-8",success:function success(res){var code=res.code,data=res.data;if(code===0&&data){var _aid=data.uint64_unique_id;var _d=decode(data.session_ticket||"");var userInfo=data.bytes_str_user_info;if(!_aid||!_d){console.log("data error");return}var loginConfig=globalVars.wpaDetail.WPA_LOGIN_CONFIG={aid:_aid,d2:_d,userInfo:userInfo,uuid:postData.str_client_uuid};window.parent.postMessage({act:"UPDATE_AUTH",data:{visitorid:loginConfig.aid,wpatoken:loginConfig.d2,uuid:postData.str_client_uuid,kfuin:kfuin}},"*");initInstant(wpa)}if(code===10017||code===600017){globalVars.wpaDetail.WPA_LOGIN_CONFIG={aid:createRandomId(),d2:"",uuid:createUuid32()};maxReTryTime-=1;if(maxReTryTime>0){socketLoginConfig(globalVars.wpaDetail)}}},error:function error(err){console.log(err)}})}(function(global){var apple_phone=/iPhone/i,apple_ipod=/iPod/i,apple_tablet=/iPad/i,android_phone=/(?=.*\bAndroid\b)(?=.*\bMobile\b)/i,android_tablet=/Android/i,amazon_phone=/(?=.*\bAndroid\b)(?=.*\bSD4930UR\b)/i,amazon_tablet=/(?=.*\bAndroid\b)(?=.*\b(?:KFOT|KFTT|KFJWI|KFJWA|KFSOWI|KFTHWI|KFTHWA|KFAPWI|KFAPWA|KFARWI|KFASWI|KFSAWI|KFSAWA)\b)/i,windows_phone=/Windows Phone/i,windows_tablet=/(?=.*\bWindows\b)(?=.*\bARM\b)/i,other_blackberry=/BlackBerry/i,other_blackberry_10=/BB10/i,other_opera=/Opera Mini/i,other_chrome=/(CriOS|Chrome)(?=.*\bMobile\b)/i,other_firefox=/(?=.*\bFirefox\b)(?=.*\bMobile\b)/i,seven_inch=new RegExp("(?:"+"Nexus 7"+"|"+"BNTV250"+"|"+"Kindle Fire"+"|"+"Silk"+"|"+"GT-P1000"+")","i");var match=function match(regex,userAgent){return regex.test(userAgent)};var IsMobileClass=function IsMobileClass(userAgent){var ua=userAgent||navigator.userAgent;var tmp=ua.split("[FBAN");if(typeof tmp[1]!=="undefined"){ua=tmp[0]}tmp=ua.split("Twitter");if(typeof tmp[1]!=="undefined"){ua=tmp[0]}this.apple={phone:match(apple_phone,ua),ipod:match(apple_ipod,ua),tablet:!match(apple_phone,ua)&&match(apple_tablet,ua),device:match(apple_phone,ua)||match(apple_ipod,ua)||match(apple_tablet,ua)};this.amazon={phone:match(amazon_phone,ua),tablet:!match(amazon_phone,ua)&&match(amazon_tablet,ua),device:match(amazon_phone,ua)||match(amazon_tablet,ua)};this.android={phone:match(amazon_phone,ua)||match(android_phone,ua),tablet:!match(amazon_phone,ua)&&!match(android_phone,ua)&&(match(amazon_tablet,ua)||match(android_tablet,ua)),device:match(amazon_phone,ua)||match(amazon_tablet,ua)||match(android_phone,ua)||match(android_tablet,ua)};this.windows={phone:match(windows_phone,ua),tablet:match(windows_tablet,ua),device:match(windows_phone,ua)||match(windows_tablet,ua)};this.other={blackberry:match(other_blackberry,ua),blackberry10:match(other_blackberry_10,ua),opera:match(other_opera,ua),firefox:match(other_firefox,ua),chrome:match(other_chrome,ua),device:match(other_blackberry,ua)||match(other_blackberry_10,ua)||match(other_opera,ua)||match(other_firefox,ua)||match(other_chrome,ua)};this.seven_inch=match(seven_inch,ua);this.any=this.apple.device||this.android.device||this.windows.device||this.other.device||this.seven_inch;this.phone=this.apple.phone||this.android.phone||this.windows.phone;this.tablet=this.apple.tablet||this.android.tablet||this.windows.tablet;if(typeof window==="undefined"){return this}};var instantiate=function instantiate(){var IM=new IsMobileClass;IM.Class=IsMobileClass;return IM};global.isMobile=instantiate()})(window);__domain||{chat:"chat.qidian.qq.com"};var StatusManager=function(window){var wpaDetail={};getVisitorId();var isLinkWPA=function(){var pageURL=window.location.href,isLinkWPA=getUrlQuery(pageURL,"linkType"),visitorId=getUrlQuery(pageURL,"visitorId"),isInIframe=window.parent==window?false:true;visitorId&&visitorId.length>0?isLinkWPA=1:"";if(isLinkWPA&&(""+isLinkWPA).length>0&&!isInIframe){return true}return false}();var pageV=pageVisibility();pageV.isPageVisibilitySupport&&pageV.visibilitychange(function(event,isHidden,visibilityState){setTimeout(function(){},500)});function postMsgListener(msgData){if(typeof msgData==="undefined")return;window["qd_qid_for_rpt"]=msgData["qid"]||"";if(msgData["__QIDIAN_WPA_VISITORID_FOR_RPT"]){window["__QIDIAN_WPA_VISITORID_FOR_RPT"]=msgData["__QIDIAN_WPA_VISITORID_FOR_RPT"]}var act=msgData.act;switch(act){case"SM_INIT":if(!wpaDetail||wpaDetail.kfuin!=msgData.kfuin){msgData.kfuin=Number(msgData.kfuin);msgData.wpaId=Number(msgData.wpaId)||"";wpaDetail=msgData;wpaDetail.linkType=msgData.linkType?1:0;globalVars.wpaDetail=wpaDetail;socketLoginConfig(wpaDetail);!isLinkWPA&&autotInviteConf(globalVars.wpaDetail)}else{return}break;case"SM_REFUSE":refuseInvite(msgData);break;case"SMS_SM_FORCE_CONNECT":break;case"SM_INVITE_RET":break;case"SM_BIND_WPA_IM_AID":if(wpaDetail.kfuin==msgData.kfuin&&wpaDetail.wpaId==msgData.wpaId){bindWpaAndImAid(msgData)}}}function createSocket(type){postMsgSender({act:"SM_READY",kfuin:getUrlQuery(location.href,"kfuin")})}function forceConnect(){}return{start:function start(){if(window.CURRENT_VISITORID){window.CURRENT_VISITORID}createSocket();postMsg.receive(window,postMsgListener)},forceConnect:forceConnect}}(window);window.__STATUS_MANAGER=StatusManager;StatusManager.start()})();
//# sourceMappingURL=statusManager.js.map
